name: Build macOS App

on: [workflow_dispatch]

jobs:
  build:
    runs-on: macos-latest

    steps:
    - uses: actions/checkout@v4

    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Install dependencies
      run: |
        brew install create-dmg
        pip install pyinstaller flask flask-sqlalchemy flask-login pytelegrambotapi python-dotenv requests pywebview

    - name: Create launcher script
      run: |
        # Create launcher.py with simple content
        echo "import webview, threading, time, sys, os" > launcher.py
        echo "sys.path.insert(0, os.path.dirname(os.path.abspath(__file__)))" >> launcher.py
        echo "def run_flask():" >> launcher.py
        echo "    from crm_zefir_bot import main" >> launcher.py
        echo "    main()" >> launcher.py
        echo "if __name__ == '__main__':" >> launcher.py
        echo "    threading.Thread(target=run_flask, daemon=True).start()" >> launcher.py
        echo "    time.sleep(5)" >> launcher.py
        echo "    webview.create_window('CRM Bot', 'http://127.0.0.1:2000', 1200, 800)" >> launcher.py
        echo "    webview.start()" >> launcher.py

    - name: Build application
      run: |
        cp crm-zefir-bot.py crm_zefir_bot.py
        pyinstaller --windowed --name CRMTelegramBot --add-data "crm_zefir_bot.py:." --add-data ".env:." launcher.py

    - name: Create disk image
      run: |
        create-dmg --volname "CRM Telegram Bot" --icon "CRMTelegramBot.app" 200 190 --app-drop-link 600 185 "CRMTelegramBot.dmg" "dist/CRMTelegramBot.app"

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: CRMTelegramBot-macOS
        path: CRMTelegramBot.dmg